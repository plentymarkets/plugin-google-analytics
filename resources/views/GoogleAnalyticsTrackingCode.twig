<script async src="https://www.googletagmanager.com/gtag/js?id={{ config("GoogleAnalytics.trackingId") }}"></script>
{% set anonymizeIP = config("GoogleAnalytics.anonymizeIPs") == "true" %}
<script type="text/plain" data-cookie-consent="{{ config('GoogleAnalytics.consentGroup') }}.googleAnalytics">

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', '{{ config("GoogleAnalytics.trackingId") }}');

    {% if anonymizeIP  %}
        gtag('set', 'anonymizeIp', true);
    {% endif %}

    {% set shippingCosts = 0 %}
    {% set webstoreConfig = services.webstoreConfig.getWebstoreConfig() %}
    {% set useGross = config("GoogleAnalytics.submitGrossPrices") == "true" %}

    {% if trackOrder %}
        {% set data = services.customer.getLatestOrder() %}
        {% if data is defined %}
            {# Calculate shipping costs #}
            {% for item in data.order.orderItems %}

                {% if item.typeId == 6 %}
                    {% if useGross %}
                        {% set shippingCosts = shippingCosts + item.amounts[0].priceGross %}
                    {% else %}
                        {% set shippingCosts = shippingCosts + item.amounts[0].priceNet %}
                    {% endif %}
                {% endif %}

            {% endfor %} 

            gtag('event','purchase',{
                'transaction_id': '{{ data.order.id }}',
                'affiliation'   : '{{ webstoreConfig.name }}',
                'value'         : '{% if useGross %}{{ data.order.amounts[0].grossTotal }}{% else %}{{ data.order.amounts[0].netTotal }}{% endif %}',
                'shipping'      : '{{ shippingCosts }}',
                'tax'           : '{{ data.order.amounts[0].vatTotal }}',
                'currency'      : '{{ data.order.amounts[0].currency }}',
                
                'items'         : [{
                {% for item in data.order.orderItems %}
                    {% if item.typeId == 1 %}
                    {
                        'item_id'   : '{{ item.variation.number }}',
                        'item_name' : '{{ item.orderItemName }}',
                        'price'     : '{% if useGross %}{{ item.amounts[0].priceGross }}{% else %}{{ item.amounts[0].priceNet }}{% endif %}',
                        'quantity'  : '{{ item.quantity }}',
                        'currency'  : '{{ item.amounts[0].currency }}'
                    },
                    {% endif %}
                {% endfor %}
                }]
            });
        {% endif %}
    {% endif %}
</script>
